<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n</title>
    <link rel="icon" type="image/png" href="favicon-32x32.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --dark: #34495e;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 28px;
        }

        /* Login Panel */
        #login-panel {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        #login-panel h2 {
            color: var(--dark);
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input[type="password"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input[type="password"]:focus,
        input[type="text"]:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Dashboard */
        #admin-panel {
            display: none;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
        }

        thead {
            background-color: var(--primary);
            color: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            line-height: 1.5;
            border-radius: 4px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-danger {
            background-color: var(--secondary);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 14px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .delete-btn {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--secondary);
            border: none;
        }

        .delete-btn:hover {
            background-color: var(--secondary);
            color: white;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s;
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
        }

        .refresh-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action buttons container */
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Alerts */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 350px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out forwards;
            position: relative;
        }

        .alert-success {
            background-color: rgba(46, 204, 113, 0.2);
            border-left: 4px solid var(--success);
            color: #27ae60;
        }

        .alert-danger {
            background-color: rgba(231, 76, 60, 0.2);
            border-left: 4px solid var(--secondary);
            color: #c0392b;
        }

        .alert .close {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
        }

        .alert .close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .modal-content h3 {
            color: var(--dark);
            margin-bottom: 15px;
        }

        .modal-content p {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: inherit;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(52, 152, 219, 0.2);
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 10px;
            }
            
            .card-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }

        .empty-message {
            text-align: center;
            padding: 30px 0;
            color: var(--gray);
            font-style: italic;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-connected {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .status-disconnected {
            background-color: rgba(189, 195, 199, 0.2);
            color: #7f8c8d;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        .role-user {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .role-admin {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .role-moderator {
            background-color: rgba(230, 126, 34, 0.2);
            color: #e67e22;
        }
        
        .role-support {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }
        
        .role-list {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .role-list li {
            margin-bottom: 8px;
        }
        
        .role-description {
            background-color: rgba(52, 152, 219, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .roles-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        /* Estilos mejorados para la gesti√≥n de roles */
        .role-btn {
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .role-btn.selected {
            border-color: currentColor;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .role-btn[data-role="user"] {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .role-btn[data-role="user"].selected {
            background-color: rgba(52, 152, 219, 0.4);
        }
        
        .role-btn[data-role="admin"] {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .role-btn[data-role="admin"].selected {
            background-color: rgba(231, 76, 60, 0.4);
        }
        
        .custom-role-btn.selected {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        .loading-roles {
            font-style: italic;
            color: #95a5a6;
            padding: 10px 0;
        }
        
        /* Estilos para roles personalizados */
        .custom-role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            background-color: rgba(var(--role-bg-color, 52, 152, 219), 0.2);
            color: var(--role-text-color, #3498db);
        }
        
        /* Estilos para selector de roles personalizado */
        .custom-role-btn {
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            background-color: #f0f0f0;
            color: #555;
            border-color: rgba(var(--role-border-color, 52, 152, 219), 0.5);
        }
        
        .custom-role-btn.selected {
            background-color: rgba(var(--role-bg-color, 52, 152, 219), 0.2);
            color: var(--role-text-color, #3498db);
            border-color: var(--role-border-color, #3498db);
        }
        
        /* Estilos para el selector de color */
        input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }
        
        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="alert-container" id="alert-container"></div>
    
    <!-- Login Panel -->
    <div id="login-panel">
        <h2>Panel de Administraci√≥n</h2>
        <form id="login-form" onsubmit="return false;">
            <div class="form-group">
                <label for="password">Contrase√±a de Administrador</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button id="login-btn" type="button" class="btn btn-primary" style="width: 100%;">Iniciar Sesi√≥n</button>
        </form>
    </div>
    
    <!-- Admin Panel -->
    <div id="admin-panel" class="container">
        <header>
            <h1>Panel de Administraci√≥n del Chat</h1>
            <button id="logout-btn" class="btn btn-danger" style="position: absolute; right: 20px; top: 20px;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
            </button>
        </header>
        
        <!-- Stats Card -->
        <div class="card">
            <div class="card-header">
                <h2>Estad√≠sticas</h2>
                            <button id="refresh-stats" class="refresh-btn" title="Actualizar estad√≠sticas">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
            <div class="card-body">
                <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                            <i class="fas fa-users"></i>
                                </div>
                        <div class="stat-number" id="total-users">0</div>
                        <div class="stat-label">Usuarios Totales</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                            <i class="fas fa-comment-dots"></i>
                                </div>
                        <div class="stat-number" id="total-messages">0</div>
                                <div class="stat-label">Mensajes Totales</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                            <i class="fas fa-plug"></i>
                        </div>
                        <div class="stat-number" id="connected-users">0</div>
                        <div class="stat-label">Usuarios Conectados</div>
                    </div>
                    </div>
                    </div>
                </div>
                
        <!-- Users Card -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-users"></i> Lista de Usuarios</h2>
                <button id="refresh-users" class="btn btn-primary btn-sm"><i class="fas fa-sync-alt"></i> Actualizar</button>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Conectado</th>
                                <th>√öltima Actividad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Messages Card -->
        <div class="card">
            <div class="card-header">
                <h2>Gesti√≥n de Mensajes</h2>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button id="delete-all-messages" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> Eliminar Todos los Mensajes
                    </button>
                </div>
                        </div>
                    </div>
        
        <!-- Rooms Card -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-comments"></i> Gesti√≥n de Salas</h2>
                <button id="refresh-rooms" class="btn btn-primary btn-sm"><i class="fas fa-sync-alt"></i> Actualizar</button>
            </div>
            <div class="card-body">
                <div class="actions" style="margin-bottom: 20px;">
                    <button id="add-room-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> A√±adir Sala
                    </button>
                    <button id="init-default-rooms-btn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Reiniciar Salas Predeterminadas
                    </button>
                    <button id="reset-default-state-btn" class="btn btn-warning">
                        <i class="fas fa-exclamation-triangle"></i> Arreglar Estado Predeterminado
                    </button>
                    <button id="clean-rooms-btn" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Eliminar Todas (Excepto General)
                    </button>
                </div>
                <div class="table-container">
                    <table id="rooms-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Slug</th>
                                <th>Descripci√≥n</th>
                                <th>Rol Requerido</th>
                                <th>Privada</th>
                                <th>Predeterminada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Room rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- User Roles Card -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-user-shield"></i> Gesti√≥n de Roles</h2>
            </div>
            <div class="card-body">
                <p class="mb-4">Aqu√≠ puedes gestionar los roles de los usuarios. Los roles determinan qu√© salas pueden acceder y qu√© acciones pueden realizar.</p>
                <div class="role-description">
                    <h4>Roles Disponibles</h4>
                    <ul class="role-list">
                        <li><strong>user</strong>: Usuario normal con acceso b√°sico</li>
                        <li><strong>admin</strong>: Administrador con acceso total al sistema</li>
                    </ul>
                </div>
                <p class="mt-4">Para cambiar el rol de un usuario, utiliza la opci√≥n "Cambiar Rol" en la tabla de usuarios.</p>
            </div>
        </div>
        
        <!-- Custom Roles Management Card -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-user-tag"></i> Roles Personalizados</h2>
                <button id="refresh-roles" class="btn btn-primary btn-sm"><i class="fas fa-sync-alt"></i> Actualizar</button>
            </div>
            <div class="card-body">
                <div class="actions" style="margin-bottom: 20px;">
                    <button id="add-role-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Crear Nuevo Rol
                    </button>
                </div>
                <div class="table-container">
                    <table id="roles-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Identificador</th>
                                <th>Descripci√≥n</th>
                                <th>Predeterminado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Role rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Reset Card -->
        <div class="card">
            <div class="card-header">
                <h2>Reinicio del Sistema</h2>
            </div>
            <div class="card-body">
                <p style="margin-bottom: 20px;">¬°PELIGRO! Esta acci√≥n eliminar√° todos los usuarios y mensajes del sistema.</p>
                <div class="actions">
                    <button id="reset-everything" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> Reiniciar Sistema
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('confirmation-modal')">&times;</span>
            <h3 id="modal-title">Confirmar Acci√≥n</h3>
            <p id="modal-message">¬øEst√°s seguro de realizar esta acci√≥n?</p>
            <div class="modal-footer">
                <button id="modal-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="modal-confirm" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <h3>Cambiar Contrase√±a</h3>
            <p>Cambiar contrase√±a para: <span id="change-password-username">Usuario</span></p>
            <input type="hidden" id="change-password-user-id" value="">
            <div class="form-group">
                <label for="new-password">Nueva Contrase√±a</label>
                <input type="password" id="new-password" name="new-password" required>
            </div>
            <div class="form-group">
                <label for="confirm-new-password">Confirmar Nueva Contrase√±a</label>
                <input type="password" id="confirm-new-password" name="confirm-new-password" required>
            </div>
            <div id="change-password-error" style="color: red; display: none; margin-bottom: 15px;"></div>
            <div class="modal-footer">
                <button id="confirm-change-password-btn" class="btn btn-primary">Guardar</button>
                <button onclick="closeModal('change-password-modal')" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para A√±adir/Editar Sala -->
    <div id="room-modal" class="modal">
        <div class="modal-content">
            <h3 id="room-modal-title">A√±adir Nueva Sala</h3>
            <input type="hidden" id="room-id" value="">
            <div class="form-group">
                <label for="room-name">Nombre de Sala</label>
                <input type="text" id="room-name" name="room-name" required>
            </div>
            <div class="form-group">
                <label for="room-slug">Slug (identificador √∫nico)</label>
                <input type="text" id="room-slug" name="room-slug" placeholder="Generado autom√°ticamente si se deja vac√≠o">
                <small class="form-text text-muted">Solo letras, n√∫meros y guiones. Se usar√° en la URL.</small>
            </div>
            <div class="form-group">
                <label for="room-description">Descripci√≥n</label>
                <textarea id="room-description" name="room-description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Rol Requerido (haz clic para seleccionar uno):</label>
                <div id="room-roles-container" class="roles-selector" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 15px;">
                    <button type="button" class="role-btn" data-role="none" style="background-color: rgba(149, 165, 166, 0.2); color: #95a5a6; border: 2px solid transparent; border-radius: 30px; padding: 8px 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">Ninguno (Todos)</button>
                    <button type="button" class="role-btn" data-role="user" style="background-color: rgba(52, 152, 219, 0.2); color: #3498db; border: 2px solid transparent; border-radius: 30px; padding: 8px 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">Usuario</button>
                    <button type="button" class="role-btn" data-role="admin" style="background-color: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 2px solid transparent; border-radius: 30px; padding: 8px 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">Administrador</button>
                </div>
                <div id="room-custom-roles-container" class="roles-selector" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <div class="roles-loading">Cargando roles personalizados...</div>
                </div>
                <input type="hidden" id="room-required-role" name="room-required-role" value="none">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="room-is-private" name="room-is-private">
                    Sala Privada (Solo usuarios espec√≠ficos)
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="room-is-default" name="room-is-default">
                    Sala Predeterminada (No se puede eliminar)
                </label>
            </div>
            <div id="room-error" style="color: red; display: none; margin-bottom: 15px;"></div>
            <div class="modal-footer">
                <button id="save-room-btn" class="btn btn-primary">Guardar</button>
                <button onclick="closeModal('room-modal')" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    
    
        <!-- Modal para gestionar m√∫ltiples roles -->
    <div id="manage-roles-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gestionar Roles</h3>
                <span class="close-modal" data-modal="manage-roles-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Gestionar los roles de <span id="manage-roles-username" class="highlight"></span></p>
                <input type="hidden" id="manage-roles-user-id">
                
                <div class="form-group">
                    <label>Roles del Sistema (haz clic para seleccionar/deseleccionar):</label>
                    <div id="system-roles-container" class="roles-selector" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="role-btn" data-role="user" style="background-color: rgba(52, 152, 219, 0.2); color: #3498db; border: 2px solid transparent; border-radius: 30px; padding: 8px 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">Usuario</button>
                        <button type="button" class="role-btn" data-role="admin" style="background-color: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 2px solid transparent; border-radius: 30px; padding: 8px 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">Administrador</button>
                    </div>
                    
                    <label>Roles Personalizados:</label>
                    <div id="roles-container" class="roles-selector" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <div class="roles-loading">Cargando roles personalizados...</div>
                    </div>
                </div>
                
                <div id="manage-roles-error" class="error-message" style="color: red; margin-top: 10px; display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-roles-btn">Cancelar</button>
                <button class="btn btn-primary" id="save-roles-btn">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para A√±adir/Editar Rol Personalizado -->
    <div id="role-modal" class="modal">
        <div class="modal-content">
            <h3 id="role-modal-title">Crear Nuevo Rol</h3>
            <input type="hidden" id="role-id" value="">
            <div class="form-group">
                <label for="role-name">Nombre del Rol</label>
                <input type="text" id="role-name" name="role-name" required>
            </div>
            <div class="form-group">
                <label for="role-identifier">Identificador</label>
                <input type="text" id="role-identifier" name="role-identifier" placeholder="Generado autom√°ticamente si se deja vac√≠o">
                <small class="form-text text-muted">Solo letras min√∫sculas, n√∫meros y guiones. Se usar√° como identificador interno.</small>
            </div>
            <div class="form-group">
                <label for="role-description">Descripci√≥n</label>
                <textarea id="role-description" name="role-description" rows="3" style="resize: none;"></textarea>
            </div>
            <div class="form-group">
                <label for="role-color">Color</label>
                <input type="color" id="role-color" name="role-color" value="#3498db">
                <small class="form-text text-muted">Color para mostrar el rol en la interfaz</small>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="role-is-default" name="role-is-default">
                    Rol Predeterminado (No se puede eliminar)
                </label>
            </div>
            <div id="role-error" style="color: red; display: none; margin-bottom: 15px;"></div>
            <div class="modal-footer">
                <button id="save-role-btn" class="btn btn-primary">Guardar</button>
                <button onclick="closeModal('role-modal')" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script>
        // Escape HTML para evitar XSS
        function escapeHTML(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Variables globales
        let adminPassword = '';
        const API_BASE_URL = window.location.origin;
        
        // Elementos DOM (Panel de Login y Admin Principal)
        const loginPanel = document.getElementById('login-panel');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const alertContainer = document.getElementById('alert-container');

        // Elementos DOM (Estad√≠sticas)
        const refreshStatsBtn = document.getElementById('refresh-stats');
        const totalUsersElement = document.getElementById('total-users');
        const totalMessagesElement = document.getElementById('total-messages');
        const connectedUsersElement = document.getElementById('connected-users');

        // Elementos DOM (Usuarios)
        const usersTable = document.getElementById('users-table');
        //const usersTbody = document.getElementById('users-tbody'); // Aseg√∫rate que este ID exista o usa getElementsByTagName
        const refreshUsersBtn = document.getElementById('refresh-users');
        // const emptyUsers = document.getElementById('empty-users'); // Aseg√∫rate que este ID exista si se usa

        // Elementos DOM (Mensajes y Sistema)
        const deleteAllMessagesBtn = document.getElementById('delete-all-messages');
        const resetEverythingBtn = document.getElementById('reset-everything');
        
        // Elementos DOM (Modal de Confirmaci√≥n General)
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        let currentConfirmAction = null; // Callback para la acci√≥n del modal de confirmaci√≥n

        // Elementos DOM (Modal de Cambio de Contrase√±a)
        const changePasswordModal = document.getElementById('change-password-modal');
        const changePasswordUserIdInput = document.getElementById('change-password-user-id');
        const changePasswordUsernameSpan = document.getElementById('change-password-username');
        const newPasswordInput = document.getElementById('new-password');
        const confirmNewPasswordInput = document.getElementById('confirm-new-password');
        const changePasswordErrorDiv = document.getElementById('change-password-error');
        const confirmChangePasswordBtn = document.getElementById('confirm-change-password-btn');
        
        // Referencias a elementos DOM para gesti√≥n de m√∫ltiples roles
        const manageRolesModal = document.getElementById('manage-roles-modal');
        const manageRolesUsernameSpan = document.getElementById('manage-roles-username');
        const manageRolesUserIdInput = document.getElementById('manage-roles-user-id');
        const rolesContainer = document.getElementById('roles-container');
        const cancelRolesBtn = document.getElementById('cancel-roles-btn');
        const saveRolesBtn = document.getElementById('save-roles-btn');
        const manageRolesErrorDiv = document.getElementById('manage-roles-error');
        
        // Referencias a elementos DOM para roles personalizados
        const rolesTable = document.getElementById('roles-table');
        const refreshRolesBtn = document.getElementById('refresh-roles');
        const addRoleBtn = document.getElementById('add-role-btn');
        const roleModal = document.getElementById('role-modal');
        const roleModalTitle = document.getElementById('role-modal-title');
        const roleIdInput = document.getElementById('role-id');
        const roleNameInput = document.getElementById('role-name');
        const roleIdentifierInput = document.getElementById('role-identifier');
        const roleDescriptionInput = document.getElementById('role-description');
        const roleColorInput = document.getElementById('role-color');
        const roleIsDefaultCheckbox = document.getElementById('role-is-default');
        const saveRoleBtn = document.getElementById('save-role-btn');
        const roleErrorDiv = document.getElementById('role-error');
        
        // Verificar si hay una sesi√≥n guardada al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            const savedSession = localStorage.getItem('adminSession');
            if (savedSession) {
                try {
                    adminPassword = savedSession;
                    loginPanel.style.display = 'none';
                    adminPanel.style.display = 'block';
                    loadInitialData();
                } catch (error) {
                    console.error('Error al recuperar sesi√≥n:', error);
                    logout();
                }
            }
        });

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadStats(),
                    loadUsers(),
                    loadRooms(), // A√±adir carga de salas
                    loadCustomRoles() // A√±adir carga de roles personalizados
                ]);
                
                showAlert('Datos actualizados correctamente', 'success');
            } catch (error) {
                showAlert(`Error al cargar datos: ${error.message}`, 'danger');
            }
        }
        
        function logout() {
            localStorage.removeItem('adminSession');
            adminPassword = '';
            loginPanel.style.display = 'block';
            adminPanel.style.display = 'none';
            const passwordField = document.getElementById('password');
            if(passwordField) passwordField.value = '';
        }
        
        logoutBtn.addEventListener('click', () => {
            showModal(
                'Cerrar Sesi√≥n',
                '¬øEst√°s seguro de que deseas cerrar la sesi√≥n?',
                logout
            );
        });
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function showAlert(message, type = 'success', container = alertContainer) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            const contentSpan = document.createElement('span');
            contentSpan.textContent = message;
            
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => alertDiv.remove();
            
            alertDiv.appendChild(contentSpan);
            alertDiv.appendChild(closeBtn);
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                if (container.contains(alertDiv)) {
                    alertDiv.style.opacity = '0';
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, 5000);
        }
        
        function setLoading(element, isLoading) {
            const existingOverlay = element.querySelector('.loading-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            if (isLoading) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                const spinner = document.createElement('div');
                spinner.className = 'spinner';
                overlay.appendChild(spinner);
                element.style.position = 'relative'; // Necesario para el posicionamiento absoluto del overlay
                element.appendChild(overlay);
            }
        }
        
        async function fetchAPI(endpoint, options = {}) {
            if (!options.headers) {
                options.headers = { 'Content-Type': 'application/json' };
            }
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(errorData.message || `Error ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error en petici√≥n a ${API_BASE_URL}${endpoint}:`, error);
                throw error;
            }
        }
        
        // Funci√≥n para manejar el proceso de inicio de sesi√≥n
        async function handleLogin() {
            console.log("Intentando iniciar sesi√≥n");
            
            const passwordInput = document.getElementById('password');
            const password = passwordInput.value;
            
            if (!password) {
                showAlert('Por favor, introduce la contrase√±a', 'danger');
                return;
            }
            
            try {
                setLoading(loginForm, true);
                console.log("Verificando contrase√±a...");
                
                // Simulaci√≥n de login, ya que la API de login real no est√° siendo usada para admin
                if (password === 'patatata123') { // Usar la contrase√±a de admin definida
                    console.log("Contrase√±a correcta");
                    adminPassword = password;
                    localStorage.setItem('adminSession', adminPassword);
                    loginPanel.style.display = 'none';
                    adminPanel.style.display = 'block';
                    loadInitialData();
                    showAlert('Has iniciado sesi√≥n correctamente', 'success');
                } else {
                    console.log("Contrase√±a incorrecta");
                    showAlert('Contrase√±a incorrecta', 'danger');
                }
            } catch (error) {
                console.error("Error en el login:", error);
                showAlert(`Error al iniciar sesi√≥n: ${error.message}`, 'danger');
            } finally {
                setLoading(loginForm, false);
            }
        }
        
        // Manejar el inicio de sesi√≥n con el bot√≥n
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        
        // Manejar la pulsaci√≥n de Enter en el campo de contrase√±a
        document.getElementById('password').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleLogin();
            }
        });
        
        async function loadStats() {
            const statsCardBody = document.querySelector('.stats-grid').closest('.card-body');
            try {
                setLoading(statsCardBody, true);
                refreshStatsBtn.classList.add('loading');
                const statsData = await fetchAPI('/api/admin/stats', {
                    method: 'POST', body: JSON.stringify({ password: adminPassword })
                });
                const usersData = await fetchAPI('/api/admin/users', { // Necesitamos esto para connected users
                    method: 'POST', body: JSON.stringify({ password: adminPassword })
                });

                if (statsData.success && statsData.stats) {
                    totalUsersElement.textContent = statsData.stats.userCount || 0;
                    totalMessagesElement.textContent = statsData.stats.messageCount || 0;
                } else {
                     totalUsersElement.textContent = 'Error';
                     totalMessagesElement.textContent = 'Error';
                }
                if (usersData.success && usersData.users) {
                    const connectedCount = usersData.users.filter(user => user.isActive && user.socketId).length;
                    connectedUsersElement.textContent = connectedCount;
                } else {
                    connectedUsersElement.textContent = 'Error';
                }

            } catch (error) {
                showAlert(`Error al cargar estad√≠sticas: ${error.message}`, 'danger');
                totalUsersElement.textContent = 'N/A';
                totalMessagesElement.textContent = 'N/A';
                connectedUsersElement.textContent = 'N/A';
            } finally {
                setLoading(statsCardBody, false);
                refreshStatsBtn.classList.remove('loading');
            }
        }
        
        async function loadUsers() {
            const usersCardBody = usersTable.closest('.card-body');
            const usersTableBody = usersTable.querySelector('tbody');
            
            try {
                setLoading(usersCardBody, true);
                refreshUsersBtn.classList.add('loading');
                
                const response = await fetchAPI('/api/admin/users', {
                    method: 'POST',
                    body: JSON.stringify({ password: adminPassword })
                });
                
                if (response.success && response.users) {
                    if (response.users.length === 0) {
                        usersTableBody.innerHTML = '<tr><td colspan="7" class="empty-message">No hay usuarios registrados.</td></tr>';
                    } else {
                        usersTableBody.innerHTML = '';
                        response.users.forEach(user => {
                            const formattedLastActive = user.lastActive ? 
                                new Date(user.lastActive).toLocaleString() : 'Nunca';
                            
                            // Formatear lista de roles y filtrar los eliminados
                            const filteredRoles = (user.roles || [user.role || 'user']).filter(role => 
                                !['moderator', 'support'].includes(role)
                            );
                            // Si al filtrar no queda ning√∫n rol, asignar 'user' por defecto
                            if (filteredRoles.length === 0) filteredRoles.push('user');
                            
                            // Generar HTML para los roles
                            let rolesHTML = '';
                            
                            // Primero buscaremos los roles personalizados para mostrarlos con el color correcto
                            fetchAPI('/api/admin/custom-roles', {
                                method: 'POST',
                                body: JSON.stringify({ password: adminPassword })
                            })
                            .then(response => {
                                if (response.success && response.roles) {
                                    const allRoles = response.roles;
                                    
                                    // Crear HTML para los roles
                                    rolesHTML = filteredRoles.map(roleId => {
                                        const roleInfo = allRoles.find(r => r.identifier === roleId);
                                        if (roleInfo) {
                                            // Si es un rol personalizado, usar su color espec√≠fico
                                            return `<span class="role-badge" style="background-color: rgba(${hexToRgb(roleInfo.color || '#3498db')}, 0.2); 
                                                color: ${roleInfo.color}">${roleInfo.name}</span>`;
                                        } else {
                                            // Si no se encuentra (raro), usar el estilo por defecto
                                            return `<span class="role-badge role-${roleId}">${roleId}</span>`;
                                        }
                                    }).join(' ');
                                    
                                    // Actualizar el contenido del TD con los roles
                                    const userRow = document.querySelector(`tr[data-user-id="${user._id}"]`);
                                    if (userRow) {
                                        const rolesTd = userRow.querySelector('.user-roles-cell');
                                        if (rolesTd) rolesTd.innerHTML = rolesHTML;
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error al cargar roles para visualizaci√≥n:', error);
                            });
                            
                            // Mostrar texto "Cargando..." mientras se obtienen los roles
                            rolesHTML = '<span class="loading-roles">Cargando roles...</span>';
                            
                            // Convertir roles a JSON para usar en data-roles
                            const rolesJSON = JSON.stringify(user.roles || [user.role || 'user']);
                            
                                                        usersTableBody.innerHTML += `
                                <tr data-user-id="${user._id}">
                                    <td>${user._id.substring(0, 8)}...</td>
                                    <td>${escapeHTML(user.username)}</td>
                                    <td>${escapeHTML(user.email || '')}</td>
                                    <td class="user-roles-cell">
                                        ${rolesHTML}
                                    </td>
                                    <td>
                                        <span class="status-badge ${user.isActive ? 'status-connected' : 'status-disconnected'}">
                                            ${user.isActive ? 'Conectado' : 'Desconectado'}
                                        </span>
                                    </td>
                                    <td>${formattedLastActive}</td>
                                <td class="actions">
                                        <button class="icon-btn manage-roles-btn" title="Gestionar Roles" data-user-id="${user._id}" data-username="${user.username}" data-roles='${rolesJSON}'>
                                            <i class="fas fa-users-cog"></i>
                                        </button>
                                        <button class="icon-btn change-password-btn" title="Cambiar Contrase√±a" data-user-id="${user._id}" data-username="${user.username}">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="icon-btn delete-btn" title="Eliminar Usuario" data-user-id="${user._id}" data-username="${user.username}">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                } else {
                    usersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Error al cargar usuarios: ${response.message || 'Desconocido'}</td></tr>`;
                }
                 // Add event listeners after rows are created
                attachUserActionListeners();
            } catch (error) {
                showAlert(`Error al cargar usuarios: ${error.message}`, 'danger');
                usersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Error cr√≠tico al cargar usuarios.</td></tr>`;
            } finally {
                setLoading(usersCardBody, false);
                refreshUsersBtn.classList.remove('loading');
            }
        }

        function attachUserActionListeners() {
            document.querySelectorAll('.change-password-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.dataset.userId;
                    const username = this.dataset.username;
                    openChangePasswordModal(userId, username);
                });
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.dataset.userId;
                    const username = this.dataset.username;
                    confirmDeleteUser(userId, username);
                });
            });
        }

        function confirmDeleteUser(userId, username) {
            showModal(
                'Eliminar Usuario',
                `¬øEst√°s seguro de que deseas eliminar al usuario <strong>${username}</strong> (ID: ${userId})? Esta acci√≥n no se puede deshacer.`,
                () => deleteUser(userId, username)
            );
        }

        async function deleteUser(userId, username) {
            const usersCardBody = usersTable.closest('.card-body');
            try {
                setLoading(usersCardBody, true);
                const response = await fetchAPI(`/api/admin/user/${userId}`, { // Usando nueva ruta DELETE
                    method: 'DELETE',
                    body: JSON.stringify({ password: adminPassword })
                });
                showAlert(`Usuario ${username} eliminado exitosamente.`, 'success');
                loadUsers(); 
                loadStats(); 
            } catch (error) {
                showAlert(`Error al eliminar usuario ${username}: ${error.message}`, 'danger');
            } finally {
                setLoading(usersCardBody, false);
            }
        }
        
        function openChangePasswordModal(userId, username) {
            changePasswordUserIdInput.value = userId;
            changePasswordUsernameSpan.textContent = username;
            changePasswordErrorDiv.style.display = 'none';
            changePasswordErrorDiv.textContent = '';
            newPasswordInput.value = '';
            confirmNewPasswordInput.value = '';
            changePasswordModal.style.display = 'flex';
            newPasswordInput.focus();
        }

        confirmChangePasswordBtn.addEventListener('click', async () => {
            const userId = changePasswordUserIdInput.value;
            const username = changePasswordUsernameSpan.textContent;
            const newPasswordValue = newPasswordInput.value;
            const confirmPasswordValue = confirmNewPasswordInput.value;

            if (newPasswordValue.length < 6) {
                changePasswordErrorDiv.textContent = 'La nueva contrase√±a debe tener al menos 6 caracteres.';
                changePasswordErrorDiv.style.display = 'block';
                return;
            }
            if (newPasswordValue !== confirmPasswordValue) {
                changePasswordErrorDiv.textContent = 'Las contrase√±as no coinciden.';
                changePasswordErrorDiv.style.display = 'block';
                return;
            }
            changePasswordErrorDiv.style.display = 'none';
            const modalContent = changePasswordModal.querySelector('.modal-content');
            try {
                setLoading(modalContent, true);
                const response = await fetchAPI('/api/admin/user/change-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        password: adminPassword, 
                        userId: userId,
                        newPassword: newPasswordValue
                    })
                });
                showAlert(`Contrase√±a para ${username} cambiada exitosamente.`, 'success');
                closeModal('change-password-modal');
            } catch (error) {
                changePasswordErrorDiv.textContent = `Error: ${error.message}`;
                changePasswordErrorDiv.style.display = 'block';
            } finally {
                setLoading(modalContent, false);
            }
        });

        // Funciones para Modales Gen√©ricos
        function showModal(title, message, onConfirmCallback) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; 
            currentConfirmAction = onConfirmCallback;
            confirmationModal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modalToClose = document.getElementById(modalId);
            if (modalToClose) {
                modalToClose.style.display = 'none';
            }
            
            // Limpiar campos espec√≠ficos seg√∫n el modal
            if (modalId === 'change-password-modal') {
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
                changePasswordErrorDiv.style.display = 'none';
                changePasswordErrorDiv.textContent = '';
            } else if (modalId === 'manage-roles-modal') {
                manageRolesErrorDiv.style.display = 'none';
                manageRolesErrorDiv.textContent = '';
                
                // Reiniciar el estado de los botones de roles del sistema
                const systemRolesContainer = document.getElementById('system-roles-container');
                const systemRoleBtns = systemRolesContainer.querySelectorAll('.role-btn');
                
                systemRoleBtns.forEach(btn => {
                    // Eliminar clase de selecci√≥n
                    btn.classList.remove('selected');
                    
                    // Restablecer estilos visuales
                    const role = btn.dataset.role;
                    let color = role === 'user' ? '#3498db' : 
                                role === 'admin' ? '#e74c3c' : '#3498db';
                    
                    btn.style.backgroundColor = `rgba(${hexToRgb(color)}, 0.2)`;
                    btn.style.border = '2px solid transparent';
                });
                
                // Limpiar el contenedor de roles personalizados para evitar duplicaci√≥n
                rolesContainer.innerHTML = '';
            }
        }

        // Asignar manejadores de eventos para botones de cerrar modales
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                const modalId = this.getAttribute('data-modal');
                closeModal(modalId);
            });
        });

        // Tambi√©n asignar handlers para botones que tengan data-modal
        document.querySelectorAll('[data-modal]').forEach(button => {
            if (!button.classList.contains('close-modal')) {
                button.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal');
                    closeModal(modalId);
                });
            }
        });

        modalConfirmBtn.addEventListener('click', () => {
            if (typeof currentConfirmAction === 'function') {
                currentConfirmAction();
            }
            closeModal('confirmation-modal');
        });

        // Acciones de Administraci√≥n (Eliminar todo, etc.)
        deleteAllMessagesBtn.addEventListener('click', () => {
            showModal('Eliminar Todos los Mensajes', '¬øEst√°s seguro de que deseas eliminar TODOS los mensajes? Esta acci√≥n no se puede deshacer.', async () => {
                const cardBody = deleteAllMessagesBtn.closest('.card-body');
                try {
                    setLoading(cardBody, true);
                    await fetchAPI('/api/admin/messages', { method: 'DELETE', body: JSON.stringify({ password: adminPassword }) });
                    showAlert('Todos los mensajes han sido eliminados.', 'success');
                    loadStats();
                } catch (error) {
                    showAlert(`Error al eliminar mensajes: ${error.message}`, 'danger');
                } finally {
                    setLoading(cardBody, false);
                }
            });
        });

        resetEverythingBtn.addEventListener('click', () => {
            showModal('Reinicio Completo del Sistema', '¬°ADVERTENCIA! Esta acci√≥n eliminar√° TODOS los usuarios y mensajes. No se puede deshacer. ¬øEst√°s seguro?', async () => {
                const cardBody = resetEverythingBtn.closest('.card-body');
                try {
                    setLoading(cardBody, true);
                    await fetchAPI('/api/admin/messages', { method: 'DELETE', body: JSON.stringify({ password: adminPassword }) });
                    await fetchAPI('/api/admin/users', { method: 'DELETE', body: JSON.stringify({ password: adminPassword }) }); // Asumiendo que esta ruta borra todos los usuarios
                    showAlert('Sistema reiniciado correctamente.', 'success');
                    loadInitialData();
                } catch (error) {
                    showAlert(`Error al reiniciar el sistema: ${error.message}`, 'danger');
                } finally {
                    setLoading(cardBody, false);
                }
            });
        });
        
        // Eventos para botones de actualizar generales
        refreshStatsBtn.addEventListener('click', loadStats);
        refreshUsersBtn.addEventListener('click', loadUsers);

        // --- GESTI√ìN DE SALAS ---
        
        // Referencias a elementos DOM para salas
        const roomsTable = document.getElementById('rooms-table');
        const refreshRoomsBtn = document.getElementById('refresh-rooms');
        const addRoomBtn = document.getElementById('add-room-btn');
        const initDefaultRoomsBtn = document.getElementById('init-default-rooms-btn');
        const roomModal = document.getElementById('room-modal');
        const roomModalTitle = document.getElementById('room-modal-title');
        const roomIdInput = document.getElementById('room-id');
        const roomNameInput = document.getElementById('room-name');
        const roomSlugInput = document.getElementById('room-slug');
        const roomDescriptionInput = document.getElementById('room-description');
        const roomRequiredRoleSelect = document.getElementById('room-required-role');
        const roomIsPrivateCheckbox = document.getElementById('room-is-private');
        const roomIsDefaultCheckbox = document.getElementById('room-is-default');
        const saveRoomBtn = document.getElementById('save-room-btn');
        const roomErrorDiv = document.getElementById('room-error');
        
        // Cargar salas al inicio
        async function loadRooms() {
            const roomsCardBody = roomsTable.closest('.card-body');
            const roomsTableBody = roomsTable.querySelector('tbody');
            
            try {
                setLoading(roomsCardBody, true);
                refreshRoomsBtn.classList.add('loading');
                
                // Primero inicializamos las salas predeterminadas y luego obtenemos todas
                await fetchAPI('/api/admin/rooms/initialize', {
                    method: 'POST',
                    body: JSON.stringify({ password: adminPassword })
                });
                
                // Ahora obtenemos las salas
                const response = await fetchAPI('/api/admin/rooms', {
                    method: 'POST',  // Convertimos a POST para poder enviar contrase√±a en body
                    body: JSON.stringify({ password: adminPassword })
                });
                
                if (response.success && response.rooms) {
                    if (response.rooms.length === 0) {
                        roomsTableBody.innerHTML = '<tr><td colspan="8" class="empty-message">No hay salas disponibles.</td></tr>';
                    } else {
                        roomsTableBody.innerHTML = '';
                        response.rooms.forEach(room => {
                            roomsTableBody.innerHTML += `
                                <tr>
                                    <td>${room._id.substring(0, 8)}...</td>
                                    <td>${escapeHTML(room.name)}</td>
                                    <td>${escapeHTML(room.slug)}</td>
                                    <td>${escapeHTML(room.description || '')}</td>
                                    <td>${escapeHTML(room.requiredRole)}</td>
                                    <td>${room.isPrivate ? 'S√≠' : 'No'}</td>
                                    <td>${room.isDefault ? 'S√≠' : 'No'}</td>
                                    <td class="actions">
                                        <button class="icon-btn edit-room-btn" title="Editar Sala" data-room-id="${room._id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="icon-btn delete-room-btn ${room.slug === 'general' ? 'disabled' : ''}" 
                                            title="${room.slug === 'general' ? 'No se puede eliminar la sala General' : 'Eliminar Sala'}" 
                                            data-room-id="${room._id}" 
                                            data-room-name="${escapeHTML(room.name)}"
                                            ${room.slug === 'general' ? 'disabled' : ''}>
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                } else {
                    roomsTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Error al cargar salas: ${response.message || 'Desconocido'}</td></tr>`;
                }
                
                // A√±adir event listeners despu√©s de crear las filas
                attachRoomActionListeners();
            } catch (error) {
                showAlert(`Error al cargar salas: ${error.message}`, 'danger');
                roomsTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Error cr√≠tico al cargar salas.</td></tr>`;
            } finally {
                setLoading(roomsCardBody, false);
                refreshRoomsBtn.classList.remove('loading');
            }
        }
        
        // A√±adir event listeners para acciones de sala
        function attachRoomActionListeners() {
            document.querySelectorAll('.edit-room-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const roomId = this.dataset.roomId;
                    editRoom(roomId);
                });
            });
            
            document.querySelectorAll('.delete-room-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (!this.hasAttribute('disabled')) {
                        const roomId = this.dataset.roomId;
                        const roomName = this.dataset.roomName;
                        confirmDeleteRoom(roomId, roomName);
                    }
                });
            });
        }
        
        // Abrir modal para a√±adir una nueva sala
        addRoomBtn.addEventListener('click', () => {
            roomModalTitle.textContent = 'A√±adir Nueva Sala';
            roomIdInput.value = '';
            roomNameInput.value = '';
            roomSlugInput.value = '';
            roomDescriptionInput.value = '';
            
            // Establecer el valor predeterminado del rol requerido
            const roomRequiredRoleInput = document.getElementById('room-required-role');
            roomRequiredRoleInput.value = 'none';
            
            roomIsPrivateCheckbox.checked = false;
            roomIsDefaultCheckbox.checked = false;
            roomErrorDiv.style.display = 'none';
            roomErrorDiv.textContent = '';
            
            // Cargar roles personalizados para el selector visual
            loadRolesForSelect();
            
            roomModal.style.display = 'flex';
            roomNameInput.focus();
        });
        
        // Abrir modal para editar una sala existente
        async function editRoom(roomId) {
            try {
                // Usamos POST en lugar de PUT para obtener los detalles de la sala
                const response = await fetchAPI(`/api/admin/room/${roomId}`, {
                    method: 'POST',
                    body: JSON.stringify({ password: adminPassword })
                });
                
                if (response.success && response.room) {
                    const room = response.room;
                    roomModalTitle.textContent = 'Editar Sala';
                    roomIdInput.value = room._id;
                    roomNameInput.value = room.name;
                    roomSlugInput.value = room.slug;
                    roomDescriptionInput.value = room.description || '';
                    
                    // Establecer el valor del rol requerido
                    const roomRequiredRoleInput = document.getElementById('room-required-role');
                    roomRequiredRoleInput.value = room.requiredRole || 'none';
                    
                    // Cargar roles personalizados (ahora con la interfaz visual)
                    await loadRolesForSelect();
                    
                    roomIsPrivateCheckbox.checked = room.isPrivate;
                    roomIsDefaultCheckbox.checked = room.isDefault;
                    roomErrorDiv.style.display = 'none';
                    roomErrorDiv.textContent = '';
                    roomModal.style.display = 'flex';
                    roomNameInput.focus();
                } else {
                    showAlert(`Error al cargar sala: ${response.message}`, 'danger');
                }
            } catch (error) {
                showAlert(`Error al cargar sala: ${error.message}`, 'danger');
            }
        }
        
        // Funci√≥n para cargar roles en el selector visual de requisito de rol
        async function loadRolesForSelect() {
            try {
                const roomRequiredRoleInput = document.getElementById('room-required-role');
                const roomRolesContainer = document.getElementById('room-roles-container');
                const roomCustomRolesContainer = document.getElementById('room-custom-roles-container');
                
                // Obtener el valor actual del rol requerido
                const currentRequiredRole = roomRequiredRoleInput.value;
                
                // Configurar botones de roles del sistema
                const systemRoleBtns = roomRolesContainer.querySelectorAll('.role-btn');
                
                // Resetear todas las selecciones
                systemRoleBtns.forEach(btn => {
                    btn.classList.remove('selected');
                    
                    // Si este es el rol actual, marcarlo como seleccionado
                    if (btn.dataset.role === currentRequiredRole) {
                        btn.classList.add('selected');
                        updateRoleButtonStyle(btn, true);
                    }
                    
                    // Asegurarse de que el evento click est√° asignado (solo una vez)
                    btn.removeEventListener('click', handleRoomRoleSelection);
                    btn.addEventListener('click', handleRoomRoleSelection);
                });
                
                // Limpiar el contenedor de roles personalizados
                roomCustomRolesContainer.innerHTML = '<div class="roles-loading">Cargando roles personalizados...</div>';
                
                // Obtener roles personalizados
                const response = await fetchAPI('/api/admin/custom-roles', {
                    method: 'POST',
                    body: JSON.stringify({ password: adminPassword })
                });
                
                if (response.success && response.roles) {
                    // Filtrar roles que no sean los predefinidos
                    const customRoles = response.roles.filter(role => 
                        !['user', 'admin', 'none'].includes(role.identifier) &&
                        !role._id.startsWith('system-')
                    );
                    
                    // Limpiar el contenedor de roles personalizados
                    roomCustomRolesContainer.innerHTML = '';
                    
                    if (customRoles.length === 0) {
                        // Mostrar mensaje si no hay roles personalizados
                        roomCustomRolesContainer.innerHTML = '<p style="color: #777; font-style: italic; margin: 0;">No hay roles personalizados disponibles</p>';
                    } else {
                        // Crear grid para roles personalizados
                        const rolesGrid = document.createElement('div');
                        rolesGrid.style.display = 'flex';
                        rolesGrid.style.flexWrap = 'wrap';
                        rolesGrid.style.gap = '10px';
                        
                        // A√±adir cada rol personalizado
                        customRoles.forEach(role => {
                            const roleBtn = document.createElement('button');
                            roleBtn.type = 'button';
                            roleBtn.className = 'custom-role-btn';
                            roleBtn.dataset.role = role.identifier;
                            roleBtn.textContent = role.name;
                            
                            // Estilos para los botones de rol personalizado
                            const bgColor = hexToRgba(role.color || '#3498db', 0.2);
                            const textColor = role.color || '#3498db';
                            
                            roleBtn.style.backgroundColor = bgColor;
                            roleBtn.style.color = textColor;
                            roleBtn.style.border = `2px solid ${textColor}40`; // 40 es 25% de opacidad en hex
                            roleBtn.style.borderRadius = '30px';
                            roleBtn.style.padding = '8px 15px';
                            roleBtn.style.fontWeight = '600';
                            roleBtn.style.cursor = 'pointer';
                            roleBtn.style.transition = 'all 0.2s ease';
                            
                            // Marcar como seleccionado si es el rol actual
                            if (role.identifier === currentRequiredRole) {
                                roleBtn.classList.add('selected');
                                roleBtn.style.backgroundColor = hexToRgba(role.color || '#3498db', 0.4);
                                roleBtn.style.border = `2px solid ${textColor}`;
                            }
                            
                            // Evento para seleccionar este rol
                            roleBtn.addEventListener('click', handleRoomRoleSelection);
                            
                            rolesGrid.appendChild(roleBtn);
                        });
                        
                        roomCustomRolesContainer.appendChild(rolesGrid);
                    }
                }
            } catch (error) {
                console.error('Error al cargar roles para el selector:', error);
                document.getElementById('room-custom-roles-container').innerHTML = 
                    '<p style="color: red; margin: 0;">Error al cargar roles personalizados</p>';
            }
        }
        
        // Funci√≥n para manejar la selecci√≥n de un rol en el selector de salas
        function handleRoomRoleSelection() {
            const roomRequiredRoleInput = document.getElementById('room-required-role');
            const roomRolesContainer = document.getElementById('room-roles-container');
            const roomCustomRolesContainer = document.getElementById('room-custom-roles-container');
            
            // Obtener todos los botones de rol (sistema y personalizados)
            const allRoleButtons = [
                ...roomRolesContainer.querySelectorAll('.role-btn'),
                ...roomCustomRolesContainer.querySelectorAll('.custom-role-btn')
            ];
            
            // Desmarcar todos los botones
            allRoleButtons.forEach(btn => {
                btn.classList.remove('selected');
                
                // Restaurar estilos de los botones del sistema
                if (btn.classList.contains('role-btn')) {
                    updateRoleButtonStyle(btn, false);
                } 
                // Restaurar estilos de los botones personalizados
                else if (btn.classList.contains('custom-role-btn')) {
                    const role = btn.dataset.role;
                    // Buscar el color del bot√≥n (est√° en el style.color)
                    const textColor = btn.style.color;
                    // Obtener el color de fondo actual (con opacidad 0.2)
                    const bgColor = btn.style.backgroundColor.replace('0.4', '0.2');
                    
                    btn.style.backgroundColor = bgColor;
                    btn.style.border = `2px solid ${textColor}40`;
                }
            });
            
            // Marcar este bot√≥n como seleccionado
            this.classList.add('selected');
            
            // Actualizar estilos seg√∫n el tipo de bot√≥n
            if (this.classList.contains('role-btn')) {
                updateRoleButtonStyle(this, true);
            } else if (this.classList.contains('custom-role-btn')) {
                // Obtener el color del texto y aumentar la opacidad del fondo
                const textColor = this.style.color;
                const bgColorWithHigherOpacity = this.style.backgroundColor.replace('0.2', '0.4');
                
                this.style.backgroundColor = bgColorWithHigherOpacity;
                this.style.border = `2px solid ${textColor}`;
            }
            
            // Actualizar el valor del input hidden
            roomRequiredRoleInput.value = this.dataset.role;
            console.log(`Rol requerido seleccionado: ${this.dataset.role}`);
        }
        
        // Funci√≥n para actualizar el estilo de un bot√≥n de rol del sistema seg√∫n si est√° seleccionado o no
        function updateRoleButtonStyle(button, isSelected) {
            // Obtener el color base del bot√≥n
            const role = button.dataset.role;
            let color;
            
            if (role === 'user') {
                color = '#3498db'; // Azul para usuario
            } else if (role === 'admin') {
                color = '#e74c3c'; // Rojo para administrador
            } else if (role === 'none') {
                color = '#95a5a6'; // Gris para ninguno
            } else {
                color = '#3498db'; // Color por defecto
            }
            
            if (isSelected) {
                // Aumentar la opacidad y cambiar el borde cuando est√° seleccionado
                button.style.backgroundColor = `rgba(${hexToRgb(color)}, 0.4)`;
                button.style.border = `2px solid ${color}`;
            } else {
                // Si no est√° seleccionado, restaurar los estilos originales
                button.style.backgroundColor = `rgba(${hexToRgb(color)}, 0.2)`;
                button.style.border = '2px solid transparent';
            }
        }
        
        // Confirmar eliminaci√≥n de sala
        function confirmDeleteRoom(roomId, roomName) {
            showModal(
                'Eliminar Sala',
                `¬øEst√°s seguro de que deseas eliminar la sala <strong>${roomName}</strong>? Esta acci√≥n no se puede deshacer.`,
                () => deleteRoom(roomId)
            );
        }
        
        // Eliminar sala
        async function deleteRoom(roomId) {
            try {
                // Usar el endpoint de emergencia
                console.log("Intentando eliminar sala con ID:", roomId);
                
                const response = await fetch('/api/admin/emergency/delete-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        roomId: roomId,
                        password: adminPassword 
                    })
                });
                
                const data = await response.json();
                console.log("Respuesta recibida:", data);
                
                if (data.success) {
                    showAlert('Sala eliminada correctamente (modo emergencia)', 'success');
                    loadRooms();
                } else {
                    showAlert(`Error al eliminar sala: ${data.message}`, 'danger');
                    console.error("Detalles del error:", data);
                }
            } catch (error) {
                showAlert(`Error cr√≠tico al eliminar sala: ${error.message}`, 'danger');
                console.error("Error completo:", error);
            }
        }
        
        // Guardar sala (crear o actualizar)
        saveRoomBtn.addEventListener('click', async () => {
            try {
                // Validar campos
                if (!roomNameInput.value.trim()) {
                    roomErrorDiv.textContent = 'El nombre de la sala es obligatorio';
                    roomErrorDiv.style.display = 'block';
                    return;
                }
                
                const roomData = {
                    name: roomNameInput.value.trim(),
                    slug: roomSlugInput.value.trim() || null, // Si est√° vac√≠o, se generar√° autom√°ticamente
                    description: roomDescriptionInput.value.trim(),
                    requiredRole: roomRequiredRoleSelect.value,
                    isPrivate: roomIsPrivateCheckbox.checked,
                    isDefault: roomIsDefaultCheckbox.checked
                };
                
                const modalContent = roomModal.querySelector('.modal-content');
                setLoading(modalContent, true);
                
                let response;
                if (roomIdInput.value) {
                    // Actualizar sala existente
                    response = await fetchAPI(`/api/admin/room/${roomIdInput.value}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...roomData,
                            password: adminPassword
                        })
                    });
                } else {
                    // Crear nueva sala
                    response = await fetchAPI('/api/admin/room', {
                        method: 'POST',
                        body: JSON.stringify({
                            ...roomData,
                            password: adminPassword
                        })
                    });
                }
                
                if (response.success) {
                    showAlert(`Sala ${roomIdInput.value ? 'actualizada' : 'creada'} correctamente`, 'success');
                    closeModal('room-modal');
                    loadRooms();
                } else {
                    roomErrorDiv.textContent = response.message || 'Error al guardar sala';
                    roomErrorDiv.style.display = 'block';
                }
            } catch (error) {
                roomErrorDiv.textContent = error.message || 'Error al guardar sala';
                roomErrorDiv.style.display = 'block';
            } finally {
                const modalContent = roomModal.querySelector('.modal-content');
                setLoading(modalContent, false);
            }
        });
        
        // Inicializar salas predeterminadas
        initDefaultRoomsBtn.addEventListener('click', async () => {
            try {
                showModal(
                    'Inicializar Salas Predeterminadas',
                    '¬øEst√°s seguro de que deseas reiniciar las salas predeterminadas? Las salas existentes no se eliminar√°n.',
                    async () => {
                        try {
                            const response = await fetchAPI('/api/admin/rooms/initialize', {
                                method: 'POST',
                                body: JSON.stringify({ password: adminPassword })
                            });
                            
                            if (response.success) {
                                showAlert('Salas predeterminadas inicializadas correctamente', 'success');
                                loadRooms();
                            } else {
                                showAlert(`Error al inicializar salas: ${response.message}`, 'danger');
                            }
                        } catch (error) {
                            showAlert(`Error al inicializar salas: ${error.message}`, 'danger');
                        }
                    }
                );
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
            }
        });
        
        // Bot√≥n para arreglar estado predeterminado
        const resetDefaultStateBtn = document.getElementById('reset-default-state-btn');
        resetDefaultStateBtn.addEventListener('click', async () => {
            try {
                showModal(
                    'Arreglar Estado Predeterminado',
                    'Esto restablecer√° el estado predeterminado de todas las salas, haciendo que SOLO la sala "General" sea predeterminada. ¬øDeseas continuar?',
                    async () => {
                        try {
                            const response = await fetchAPI('/api/admin/rooms/reset-default-state', {
                                method: 'POST',
                                body: JSON.stringify({ password: adminPassword })
                            });
                            
                            if (response.success) {
                                showAlert('Estado predeterminado de salas corregido correctamente', 'success');
                                loadRooms();
                            } else {
                                showAlert(`Error al arreglar estado: ${response.message}`, 'danger');
                            }
                        } catch (error) {
                            showAlert(`Error al arreglar estado: ${error.message}`, 'danger');
                        }
                    }
                );
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
            }
        });
        
        // Bot√≥n para eliminar todas las salas excepto General
        const cleanRoomsBtn = document.getElementById('clean-rooms-btn');
        cleanRoomsBtn.addEventListener('click', async () => {
            try {
                showModal(
                    'Eliminar Todas las Salas',
                    '¬øEst√°s seguro de que deseas eliminar TODAS las salas excepto General? Esta acci√≥n no se puede deshacer.',
                    async () => {
                        try {
                            // Obtener todas las salas actuales
                            const response = await fetchAPI('/api/admin/rooms', {
                                method: 'POST',
                                body: JSON.stringify({ password: adminPassword })
                            });
                            
                            if (!response.success) {
                                showAlert(`Error al obtener salas: ${response.message}`, 'danger');
                                return;
                            }
                            
                            // Filtrar salas que no sean General
                            const roomsToDelete = response.rooms.filter(room => room.slug !== 'general');
                            
                            if (roomsToDelete.length === 0) {
                                showAlert('No hay salas para eliminar excepto General', 'info');
                                return;
                            }
                            
                            // Eliminar cada sala utilizando el endpoint de emergencia
                            let successCount = 0;
                            let errorCount = 0;
                            
                            const deletePromises = roomsToDelete.map(async room => {
                                try {
                                    console.log(`Eliminando sala en modo emergencia: ${room.name} (${room._id})`);
                                    
                                    const response = await fetch('/api/admin/emergency/delete-room', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ 
                                            roomId: room._id,
                                            password: adminPassword 
                                        })
                                    });
                                    
                                    const data = await response.json();
                                    console.log(`Respuesta para sala ${room.name}:`, data);
                                    
                                    if (data.success) {
                                        successCount++;
                                    } else {
                                        errorCount++;
                                        console.error(`Error al eliminar sala ${room.name}: ${data.message}`, data);
                                    }
                                } catch (deleteError) {
                                    errorCount++;
                                    console.error(`Error cr√≠tico al eliminar sala ${room.name}:`, deleteError);
                                }
                            });
                            
                            // Esperar a que todas las promesas se resuelvan
                            await Promise.all(deletePromises);
                            
                            if (successCount > 0) {
                                showAlert(`${successCount} salas eliminadas correctamente${errorCount > 0 ? `, ${errorCount} errores` : ''}`, 'success');
                            } else {
                                showAlert('No se pudo eliminar ninguna sala', 'danger');
                            }
                            
                            // Recargar lista de salas
                            loadRooms();
                            
                        } catch (error) {
                            showAlert(`Error al limpiar salas: ${error.message}`, 'danger');
                            console.error("Error completo al limpiar salas:", error);
                        }
                    }
                );
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
            }
        });

        // --- GESTI√ìN DE ROLES ---
        
        // Modificar la funci√≥n attachUserActionListeners para a√±adir listener para gesti√≥n de roles
        function attachUserActionListeners() {
            document.querySelectorAll('.change-password-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.dataset.userId;
                    const username = this.dataset.username;
                    openChangePasswordModal(userId, username);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.dataset.userId;
                    const username = this.dataset.username;
                    confirmDeleteUser(userId, username);
                });
            });
            

            
            document.querySelectorAll('.manage-roles-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.dataset.userId;
                    const username = this.dataset.username;
                    const roles = JSON.parse(this.dataset.roles || '["user"]');
                    openManageRolesModal(userId, username, roles);
                });
            });
        }
        
        // Funci√≥n para abrir el modal de gesti√≥n de roles
        function openManageRolesModal(userId, username, roles) {
            manageRolesUserIdInput.value = userId;
            manageRolesUsernameSpan.textContent = username;
            manageRolesErrorDiv.style.display = 'none';
            manageRolesErrorDiv.textContent = '';
            
            // Limpiar el contenedor de roles actual
            rolesContainer.innerHTML = '<div class="roles-loading">Cargando roles personalizados...</div>';
            
            // Funci√≥n global para alternar la selecci√≥n de un rol
            // Esta funci√≥n ser√° reusable para todos los botones de rol
            function handleRoleButtonClick(event) {
                const button = event.currentTarget;
                button.classList.toggle('selected');
                
                // Obtener informaci√≥n de color del bot√≥n
                let color, textColor;
                
                if (button.classList.contains('role-btn')) {
                    // Es un bot√≥n de rol de sistema
                    const role = button.dataset.role;
                    color = role === 'user' ? '#3498db' : 
                           role === 'admin' ? '#e74c3c' : '#95a5a6';
                    
                    if (button.classList.contains('selected')) {
                        button.style.backgroundColor = `rgba(${hexToRgb(color)}, 0.4)`;
                        button.style.border = `2px solid ${color}`;
                    } else {
                        button.style.backgroundColor = `rgba(${hexToRgb(color)}, 0.2)`;
                        button.style.border = '2px solid transparent';
                    }
                } else {
                    // Es un bot√≥n de rol personalizado
                    color = button.style.color || '#3498db';
                    
                    if (button.classList.contains('selected')) {
                        button.style.backgroundColor = button.style.backgroundColor.replace('0.2', '0.4');
                        button.style.border = `2px solid ${color}`;
                    } else {
                        button.style.backgroundColor = button.style.backgroundColor.replace('0.4', '0.2');
                        button.style.border = `2px solid ${color}40`;
                    }
                }
            }
            
            // Configurar botones de roles del sistema
            const systemRolesContainer = document.getElementById('system-roles-container');
            const systemRoleBtns = systemRolesContainer.querySelectorAll('.role-btn');
            
            // Resetear todas las selecciones
            systemRoleBtns.forEach(btn => {
                // Remover todos los event listeners anteriores
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                // Verificar si este rol est√° incluido en los roles del usuario
                if (roles.includes(newBtn.dataset.role)) {
                    newBtn.classList.add('selected');
                    
                    // Actualizar estilos visuales
                    const role = newBtn.dataset.role;
                    let color = role === 'user' ? '#3498db' : 
                               role === 'admin' ? '#e74c3c' : '#95a5a6';
                    
                    newBtn.style.backgroundColor = `rgba(${hexToRgb(color)}, 0.4)`;
                    newBtn.style.border = `2px solid ${color}`;
                }
                
                // A√±adir evento click
                newBtn.addEventListener('click', handleRoleButtonClick);
            });
            
            // Cargar todos los roles desde el servidor
            fetchAPI('/api/admin/custom-roles', {
                method: 'POST',
                body: JSON.stringify({ password: adminPassword })
            })
            .then(response => {
                if (response.success && response.roles) {
                    // Filtrar para obtener solo roles personalizados (no del sistema)
                    const customRoles = response.roles.filter(role => 
                        !['user', 'admin', 'moderator', 'support'].includes(role.identifier) && 
                        !role._id.startsWith('system-')
                    );
                    
                    // Limpiar el contenedor de roles personalizados
                    rolesContainer.innerHTML = '';
                    
                    if (customRoles.length === 0) {
                        // Mostrar mensaje si no hay roles personalizados
                        rolesContainer.innerHTML = '<p style="color: #777; font-style: italic;">No hay roles personalizados disponibles</p>';
                    } else {
                        // Crear grid para roles personalizados
                        const rolesGrid = document.createElement('div');
                        rolesGrid.style.display = 'flex';
                        rolesGrid.style.flexWrap = 'wrap';
                        rolesGrid.style.gap = '10px';
                        
                        // A√±adir cada rol personalizado
                        customRoles.forEach(role => {
                            const roleBtn = document.createElement('button');
                            roleBtn.type = 'button';
                            roleBtn.className = 'custom-role-btn';
                            roleBtn.dataset.role = role.identifier;
                            roleBtn.textContent = role.name;
                            
                            // Estilos para los botones de rol personalizado
                            const bgColor = hexToRgba(role.color || '#3498db', 0.2);
                            const textColor = role.color || '#3498db';
                            
                            roleBtn.style.backgroundColor = bgColor;
                            roleBtn.style.color = textColor;
                            roleBtn.style.border = `2px solid ${textColor}40`; // 40 es 25% de opacidad en hex
                            roleBtn.style.borderRadius = '30px';
                            roleBtn.style.padding = '8px 15px';
                            roleBtn.style.fontWeight = '600';
                            roleBtn.style.cursor = 'pointer';
                            roleBtn.style.transition = 'all 0.2s ease';
                            
                            // Marcar como seleccionado si el usuario tiene este rol
                            if (roles.includes(role.identifier)) {
                                roleBtn.classList.add('selected');
                                roleBtn.style.backgroundColor = hexToRgba(role.color || '#3498db', 0.4);
                                roleBtn.style.border = `2px solid ${textColor}`;
                            }
                            
                            // Usar el mismo manejador de eventos para consistencia
                            roleBtn.addEventListener('click', handleRoleButtonClick);
                            
                            rolesGrid.appendChild(roleBtn);
                        });
                        
                        rolesContainer.appendChild(rolesGrid);
                    }
                } else {
                    rolesContainer.innerHTML = '<p style="color: red;">Error al cargar roles personalizados</p>';
                }
            })
            .catch(error => {
                console.error('Error al cargar roles personalizados:', error);
                rolesContainer.innerHTML = '<p style="color: red;">Error al cargar roles personalizados</p>';
            })
            .finally(() => {
                manageRolesModal.style.display = 'flex';
            });
        }
        
        // Funci√≥n auxiliar para convertir color hex a rgba
        function hexToRgba(hex, alpha = 1) {
            const rgb = hexToRgb(hex).split(',').map(Number);
            return `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${alpha})`;
        }

        // Funci√≥n auxiliar para convertir color hexadecimal a RGB
        function hexToRgb(hex) {
            // Asegurar que el hex tenga el formato correcto
            hex = hex.replace(/^#/, '');
            
            // Parsear los componentes
            let r, g, b;
            if (hex.length === 3) {
                r = parseInt(hex.charAt(0) + hex.charAt(0), 16);
                g = parseInt(hex.charAt(1) + hex.charAt(1), 16);
                b = parseInt(hex.charAt(2) + hex.charAt(2), 16);
            } else {
                r = parseInt(hex.substring(0, 2), 16);
                g = parseInt(hex.substring(2, 4), 16);
                b = parseInt(hex.substring(4, 6), 16);
            }
            
            return `${r}, ${g}, ${b}`;
        }

        // Cerrar modal con bot√≥n cancelar
        cancelRolesBtn.addEventListener('click', () => closeModal('manage-roles-modal'));
        
        // Guardar cambios de roles m√∫ltiples
        saveRolesBtn.addEventListener('click', async () => {
            const userId = manageRolesUserIdInput.value;
            const username = manageRolesUsernameSpan.textContent;
            
            try {
                // Obtener los roles seleccionados del sistema
                const systemRolesContainer = document.getElementById('system-roles-container');
                const selectedSystemRoles = Array.from(systemRolesContainer.querySelectorAll('.role-btn.selected'))
                    .map(button => button.dataset.role);
                
                // Obtener los roles personalizados seleccionados
                const customRolesContainer = document.getElementById('roles-container');
                const selectedCustomRoles = Array.from(customRolesContainer.querySelectorAll('.custom-role-btn.selected'))
                    .map(button => button.dataset.role);
                
                // Combinar todos los roles seleccionados
                let selectedRoles = [...selectedSystemRoles, ...selectedCustomRoles];
                
                // Filtrar para eliminar roles no deseados
                selectedRoles = selectedRoles.filter(role => !['moderator', 'support'].includes(role));
                
                if (selectedRoles.length === 0) {
                    manageRolesErrorDiv.textContent = 'Debe seleccionar al menos un rol';
                    manageRolesErrorDiv.style.display = 'block';
                    return;
                }
                
                setLoading(manageRolesModal.querySelector('.modal-content'), true);
                
                const response = await fetchAPI(`/api/admin/user/${userId}/roles`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        password: adminPassword,
                        roles: selectedRoles
                    })
                });
                
                if (response.success) {
                    showAlert(`Roles de ${username} actualizados correctamente`, 'success');
                    closeModal('manage-roles-modal');
                    loadUsers(); // Recargar usuarios para ver los cambios
                } else {
                    manageRolesErrorDiv.textContent = response.message || 'Error al actualizar roles';
                    manageRolesErrorDiv.style.display = 'block';
                }
            } catch (error) {
                manageRolesErrorDiv.textContent = error.message || 'Error al actualizar roles';
                manageRolesErrorDiv.style.display = 'block';
            } finally {
                setLoading(manageRolesModal.querySelector('.modal-content'), false);
            }
        });

        modalCancelBtn.addEventListener('click', () => closeModal('confirmation-modal'));

        window.addEventListener('click', (event) => {
            if (event.target === confirmationModal) closeModal('confirmation-modal');
            if (event.target === changePasswordModal) closeModal('change-password-modal');
            if (event.target === manageRolesModal) closeModal('manage-roles-modal');
            if (event.target === roomModal) closeModal('room-modal');
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (confirmationModal.style.display === 'flex') closeModal('confirmation-modal');
                if (changePasswordModal.style.display === 'flex') closeModal('change-password-modal');
                if (manageRolesModal.style.display === 'flex') closeModal('manage-roles-modal');
                if (roomModal.style.display === 'flex') closeModal('room-modal');
            }
        });

        // --- GESTI√ìN DE ROLES PERSONALIZADOS ---
        
        // Cargar roles personalizados
        async function loadCustomRoles() {
            const rolesCardBody = rolesTable.closest('.card-body');
            const rolesTableBody = rolesTable.querySelector('tbody');
            
            try {
                setLoading(rolesCardBody, true);
                refreshRolesBtn.classList.add('loading');
                
                // Obtener roles personalizados
                const response = await fetchAPI('/api/admin/custom-roles', {
                    method: 'POST',
                    body: JSON.stringify({ password: adminPassword })
                });
                
                if (response.success && response.roles) {
                    // Filtrar roles para no mostrar moderador y soporte
                    const filteredRoles = response.roles.filter(role => 
                        !['moderator', 'support'].includes(role.identifier)
                    );
                    
                    if (filteredRoles.length === 0) {
                        rolesTableBody.innerHTML = '<tr><td colspan="6" class="empty-message">No hay roles personalizados disponibles.</td></tr>';
                    } else {
                        rolesTableBody.innerHTML = '';
                        filteredRoles.forEach(role => {
                            const isSystemRole = role.isSystemRole === true || role._id.startsWith('system-');
                            const colorPreview = `<span class="color-preview" style="background-color: ${role.color || '#3498db'}"></span>`;
                            
                            rolesTableBody.innerHTML += `
                                <tr>
                                    <td>${role._id.substring(0, 8)}...</td>
                                    <td>${colorPreview}${escapeHTML(role.name)}</td>
                                    <td>${escapeHTML(role.identifier)}</td>
                                    <td>${escapeHTML(role.description || '')}</td>
                                    <td>
                                        ${role.isDefault ? 'S√≠' : 'No'}
                                        ${!isSystemRole && role.isDefault ? 
                                            `<button class="btn btn-sm btn-warning toggle-default-btn" 
                                                title="Desmarcar como predeterminado" 
                                                data-role-id="${role._id}" 
                                                data-role-name="${escapeHTML(role.name)}"
                                                data-is-default="false">
                                                <i class="fas fa-star"></i>
                                            </button>` : 
                                            !isSystemRole && !role.isDefault ? 
                                            `<button class="btn btn-sm btn-outline-warning toggle-default-btn" 
                                                title="Marcar como predeterminado" 
                                                data-role-id="${role._id}" 
                                                data-role-name="${escapeHTML(role.name)}"
                                                data-is-default="true">
                                                <i class="far fa-star"></i>
                                            </button>` : ''
                                        }
                                    </td>
                                    <td class="actions">
                                        <button class="icon-btn edit-role-btn" title="Editar Rol" data-role-id="${role._id}" ${isSystemRole ? 'disabled' : ''}>
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="icon-btn delete-role-btn ${isSystemRole || role.isDefault ? 'disabled' : ''}" 
                                            title="${isSystemRole ? 'No se puede eliminar un rol del sistema' : role.isDefault ? 'Desmarque como predeterminado primero' : 'Eliminar Rol'}" 
                                            data-role-id="${role._id}" 
                                            data-role-name="${escapeHTML(role.name)}"
                                            ${isSystemRole || role.isDefault ? 'disabled' : ''}>
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                } else {
                    rolesTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error al cargar roles: ${response.message || 'Desconocido'}</td></tr>`;
                }
                
                // A√±adir event listeners despu√©s de crear las filas
                attachRoleActionListeners();
            } catch (error) {
                showAlert(`Error al cargar roles personalizados: ${error.message}`, 'danger');
                rolesTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error cr√≠tico al cargar roles.</td></tr>`;
            } finally {
                setLoading(rolesCardBody, false);
                refreshRolesBtn.classList.remove('loading');
            }
        }
        
        // A√±adir event listeners para acciones de roles
        function attachRoleActionListeners() {
            document.querySelectorAll('.edit-role-btn').forEach(button => {
                if (!button.hasAttribute('disabled')) {
                    button.addEventListener('click', function() {
                        const roleId = this.dataset.roleId;
                        editRole(roleId);
                    });
                }
            });
            
            document.querySelectorAll('.delete-role-btn').forEach(button => {
                if (!button.hasAttribute('disabled')) {
                    button.addEventListener('click', function() {
                        const roleId = this.dataset.roleId;
                        const roleName = this.dataset.roleName;
                        confirmDeleteRole(roleId, roleName);
                    });
                }
            });
            
            // A√±adir listener para botones de cambiar estado predeterminado
            document.querySelectorAll('.toggle-default-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const roleId = this.dataset.roleId;
                    const roleName = this.dataset.roleName;
                    const isDefault = this.dataset.isDefault === 'true';
                    toggleDefaultStatus(roleId, roleName, isDefault);
                });
            });
        }
        
        // Abrir modal para a√±adir un nuevo rol
        addRoleBtn.addEventListener('click', () => {
            roleModalTitle.textContent = 'Crear Nuevo Rol';
            roleIdInput.value = '';
            roleNameInput.value = '';
            roleIdentifierInput.value = '';
            roleDescriptionInput.value = '';
            roleColorInput.value = '#3498db';
            roleIsDefaultCheckbox.checked = false;
            roleErrorDiv.style.display = 'none';
            roleErrorDiv.textContent = '';
            
            // Actualizar placeholder para ser m√°s claro
            roleIdentifierInput.placeholder = 'Se generar√° autom√°ticamente si se deja vac√≠o';
            
            roleModal.style.display = 'flex';
            roleNameInput.focus();
            
            // Evento para generar identificador autom√°tico al escribir el nombre
            const updateIdentifierSuggestion = () => {
                if (roleIdentifierInput.value.trim() === '') {
                    const suggestedId = generateIdentifier(roleNameInput.value);
                    if (suggestedId) {
                        roleIdentifierInput.placeholder = `Sugerencia: ${suggestedId}`;
                    }
                }
            };
            
            // Limpiar eventos anteriores si existen
            roleNameInput.removeEventListener('input', updateIdentifierSuggestion);
            // A√±adir el evento
            roleNameInput.addEventListener('input', updateIdentifierSuggestion);
        });
        
        // Abrir modal para editar un rol existente
        async function editRole(roleId) {
            try {
                const response = await fetchAPI(`/api/admin/custom-role/${roleId}`, {
                    method: 'POST',
                    body: JSON.stringify({ password: adminPassword })
                });
                
                if (response.success && response.role) {
                    const role = response.role;
                    roleModalTitle.textContent = 'Editar Rol';
                    roleIdInput.value = role._id;
                    roleNameInput.value = role.name;
                    roleIdentifierInput.value = role.identifier;
                    roleDescriptionInput.value = role.description || '';
                    roleColorInput.value = role.color || '#3498db';
                    roleIsDefaultCheckbox.checked = role.isDefault;
                    roleErrorDiv.style.display = 'none';
                    roleErrorDiv.textContent = '';
                    roleModal.style.display = 'flex';
                    roleNameInput.focus();
                } else {
                    showAlert(`Error al cargar rol: ${response.message}`, 'danger');
                }
            } catch (error) {
                showAlert(`Error al cargar rol: ${error.message}`, 'danger');
            }
        }
        
        // Confirmar eliminaci√≥n de rol
        function confirmDeleteRole(roleId, roleName) {
            showModal(
                'Eliminar Rol',
                `¬øEst√°s seguro de que deseas eliminar el rol <strong>${roleName}</strong>? Esta acci√≥n no se puede deshacer y puede afectar a los usuarios que tengan este rol asignado.`,
                () => deleteRole(roleId)
            );
        }
        
        // Eliminar rol
        async function deleteRole(roleId) {
            try {
                const response = await fetchAPI(`/api/admin/custom-role/${roleId}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ password: adminPassword })
                });
                
                if (response.success) {
                    showAlert('Rol eliminado correctamente', 'success');
                    loadCustomRoles();
                    // Tambi√©n actualizamos los usuarios para reflejar los cambios en los roles
                    loadUsers();
                } else {
                    showAlert(`Error al eliminar rol: ${response.message}`, 'danger');
                }
            } catch (error) {
                showAlert(`Error al eliminar rol: ${error.message}`, 'danger');
            }
        }
        
        // Funci√≥n para generar un identificador a partir del nombre
        function generateIdentifier(name) {
            // Convertir a min√∫sculas y reemplazar espacios y caracteres especiales
            return name.toLowerCase()
                .replace(/\s+/g, '-')       // Reemplazar espacios por guiones
                .replace(/[^a-z0-9-]/g, '') // Eliminar caracteres no permitidos
                .replace(/-+/g, '-')        // Reemplazar m√∫ltiples guiones por uno solo
                .replace(/^-|-$/g, '');     // Eliminar guiones al inicio y al final
        }
        
        // Guardar rol (crear o actualizar)
        saveRoleBtn.addEventListener('click', async () => {
            try {
                // Validar campos
                if (!roleNameInput.value.trim()) {
                    roleErrorDiv.textContent = 'El nombre del rol es obligatorio';
                    roleErrorDiv.style.display = 'block';
                    return;
                }
                
                // Validar identificador (solo letras min√∫sculas, n√∫meros y guiones)
                let identifier = roleIdentifierInput.value.trim();
                
                // Si el identificador est√° vac√≠o, generarlo a partir del nombre
                if (!identifier) {
                    identifier = generateIdentifier(roleNameInput.value);
                    // Si sigue vac√≠o o es una palabra reservada, generar uno con timestamp
                    if (!identifier || ['user', 'admin', 'moderator', 'support', 'none'].includes(identifier)) {
                        identifier = 'custom-' + Date.now().toString().substring(8);
                    }
                } else if (!/^[a-z0-9-]+$/.test(identifier)) {
                    roleErrorDiv.textContent = 'El identificador solo puede contener letras min√∫sculas, n√∫meros y guiones';
                    roleErrorDiv.style.display = 'block';
                    return;
                }
                
                console.log("Usando identificador:", identifier);
                
                const roleData = {
                    name: roleNameInput.value.trim(),
                    identifier: identifier, // Usar el identificador generado o proporcionado
                    description: roleDescriptionInput.value.trim(),
                    color: roleColorInput.value,
                    isDefault: roleIsDefaultCheckbox.checked
                };
                
                const modalContent = roleModal.querySelector('.modal-content');
                setLoading(modalContent, true);
                
                console.log("Enviando datos del rol:", JSON.stringify(roleData));
                let response;
                
                try {
                    if (roleIdInput.value) {
                        // Actualizar rol existente
                        response = await fetchAPI(`/api/admin/custom-role/${roleIdInput.value}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                ...roleData,
                                password: adminPassword
                            })
                        });
                    } else {
                        // Crear nuevo rol
                        response = await fetchAPI('/api/admin/custom-role', {
                            method: 'POST',
                            body: JSON.stringify({
                                ...roleData,
                                password: adminPassword
                            })
                        });
                    }
                    
                    if (response.success) {
                        showAlert(`Rol ${roleIdInput.value ? 'actualizado' : 'creado'} correctamente`, 'success');
                        closeModal('role-modal');
                        loadCustomRoles();
                    } else {
                        console.error("Error en la respuesta del servidor:", response);
                        roleErrorDiv.textContent = response.message || 'Error al guardar rol';
                        roleErrorDiv.style.display = 'block';
                    }
                } catch (err) {
                    console.error("Error detallado:", err);
                    if (err.message.includes("identifier")) {
                        roleErrorDiv.textContent = "Error con el identificador. Prueba con uno diferente o d√©jalo vac√≠o.";
                    } else {
                        roleErrorDiv.textContent = `Error: ${err.message}`;
                    }
                    roleErrorDiv.style.display = 'block';
                }
            } catch (error) {
                roleErrorDiv.textContent = error.message || 'Error al guardar rol';
                roleErrorDiv.style.display = 'block';
            } finally {
                const modalContent = roleModal.querySelector('.modal-content');
                setLoading(modalContent, false);
            }
        });
        
        // A√±adir los botones de roles a los listeners de eventos de cierre
        refreshRolesBtn.addEventListener('click', loadCustomRoles);

        // Despu√©s de la funci√≥n deleteRole, a√±adir la nueva funci√≥n toggleDefaultStatus:
        // Cambiar el estado predeterminado de un rol
        async function toggleDefaultStatus(roleId, roleName, isDefault) {
            try {
                const response = await fetchAPI(`/api/admin/custom-role/${roleId}/default-status`, {
                    method: 'PUT',
                    body: JSON.stringify({ 
                        password: adminPassword,
                        isDefault: isDefault
                    })
                });
                
                if (response.success) {
                    showAlert(`Estado del rol ${roleName} cambiado a ${isDefault ? 'predeterminado' : 'no predeterminado'} correctamente`, 'success');
                    loadCustomRoles();
                    // Tambi√©n actualizamos los usuarios para reflejar los cambios en los roles
                    loadUsers();
                } else {
                    showAlert(`Error al cambiar estado del rol: ${response.message}`, 'danger');
                }
            } catch (error) {
                showAlert(`Error al cambiar estado del rol: ${error.message}`, 'danger');
            }
        }
    </script>
</body>
</html> 
